<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CyberBall</title>
		<link rel="stylesheet" href="styles/game.css" />
		<style>
			h2 {
				margin: 0 auto;
			}

			[v-cloak] {
				display: none !important;
			}

			/* 固定在右上角的菜单选项按钮 */
			#menu-btn {
				position: absolute;
				top: 0;
				right: 0;
			}
			#menu-btn > button {
				width: 4rem;
				font-size: 0.8rem;
			}

			/* #menu-wrap {
				position: absolute;
				top:10vh;
				left:10vw;
				width: 80vw;
				height: 80vh;
			}

			.menu {
				background-color: white;
				margin: 0 auto;
				width: inherit;
				max-width: 50rem;
				height: inherit;
			} */

			/* 包裹游戏页面中的主要内容 */
			#game-page {
				width: 100%;
				display: grid;
				text-align: center;
				justify-items: center;
				align-items: center;
			}

			/* 页面的共同设置 */
			.main-page,
			.pre-begin-page {
				width: inherit;
				height: 100%;
			}

			.ball {
				position: absolute;
				top: 0;
				left: 0;
				width: 2rem;
			}

			/* 包裹游戏主界面中所有players的div */
			.players-wrap {
				display: grid;
				grid-template-columns: 1fr 1fr 1fr;
				grid-template-rows: 1fr;
			}

			/* 放单个player图片、球球、名字的盒子（类似container） */
			.player-icon {
				width: 6rem;
				margin: 6vh auto 2vh;
			}

			.player-img {
				width: 100%;
			}

			/* .display-names {
				position: relative;
				top: -2rem;
			} */

			/* 在player头顶占坑（用于排版players位置） */
			.down {
				margin-top: 20vh;
			}

			.player-name > input {
				width: 5rem;
				font-size: smaller;
			}

			.row {
				display: flex;
				align-items: flex-end;
				justify-content: center;
			}

			.btn-wrap {
				margin-top: 5vh;
			}

			.player-leftWard {
				transform: scale(-1, 1);
			}

			.player-rightWard {
				transform: scale(1, 1);
			}
		</style>
	</head>
	<body>
		<div class="game-canvas">
			<div class="canvas-wrap">
				<div id="game-page" v-cloak>
					<h1>CyberBall</h1>
					<!-- page-1 -->
					<div class="pre-begin-page" v-if="isShow.pre">
						<div class="player-name">
							昵称：<input
								type="text"
								placeholder="请输入昵称"
								v-model="player.name"
							/>
						</div>
						<div class="player-icon">
							<img
								ref="player00"
								class="player-img"
								src="Images/Cyberboy/idle-right.png"
								width="100%"
								:style="`filter: sepia(1) saturate(20) hue-rotate(${player.hues[0]}deg) grayscale(${player.grays[0]}%);`"
							/>
						</div>
						<div class="color-option">
							<div class="row">
								色调：<input
									class="color-bar"
									type="range"
									max="360"
									v-model="player.hues[0]"
								/>
							</div>
							<div class="row">
								灰度：<input
									class="color-bar"
									type="range"
									v-model="player.grays[0]"
								/>
							</div>
						</div>
						<div class="btn-wrap">
							<button @click="enterGame">进入游戏</button>
						</div>
					</div>

					<!-- page-2 -->
					<div class="main-page" v-if="isShow.main">
						<h2>游戏正在开发中，敬请期待 :)</h2>
						<div class="players-wrap">
							<!-- player的模版 -->
							<div class="player-icon">
								<img
									ref="player1"
									class="player-img"
									src="Images/Cyberboy/idle-right.png"
									width="100%"
									:style="`filter: sepia(1) saturate(20) hue-rotate(${player.hues[1]}deg) grayscale(${player.grays[1]}%);`"
									@click="moveBall(1)"
									@mouseover="playerTurn('left')"
								/>
								<p class="display-names">AI1</p>
							</div>

							<div class="player-icon">
								<img
									ref="player0"
									class="player-img down"
									:class="player.isLeftWard? 'player-leftWard': 'player-rightWard'"
									src="Images/Cyberboy/idle-right.png"
									width="100%"
									:style="`filter: sepia(1) saturate(20) hue-rotate(${player.hues[0]}deg) grayscale(${player.grays[0]}%); transition:${player.turnDur}s linear`"
								/>
								<p class="display-names">{{ player.name }}</p>
							</div>

							<div class="player-icon">
								<img
									ref="player2"
									class="player-img player-leftWard"
									src="Images/Cyberboy/idle-right.png"
									width="100%"
									:style="`filter: sepia(1) saturate(20) hue-rotate(${player.hues[2]}deg) grayscale(${player.grays[2]}%)`"
									@click="moveBall(2, undefined, 0)"
									@mouseover="playerTurn('right')"
								/>
								<p class="display-names">AI2</p>
							</div>
						</div>
					</div>

					<!-- 球 -->
					<img
						class="ball"
						src="Images/ball.png"
						:style="`transform:translate(${ball.pos[0]}vw, ${ball.pos[1]}rem); transition: ${ball.moveDur}s linear`"
					/>

					<!-- 菜单 -->
					<div id="menu-btn">
						<button @click="openMenu">返回</button>
					</div>
					<div id="menu-wrap" v-if="isShow.menu">
						<!-- <div class="menu"></div> -->
					</div>
				</div>
			</div>
		</div>
		<script src="script/vue.global.prod.js"></script>
		<script>
			// rem
			let fontSize = 16;
			const BALL_DX = 67;
			const BALL_DY = 5;
			const LOAD_DELAY = 10;

			const delay = function delayCallFn(fn, delayTime) {
				return function (...args) {
					let timer = setTimeout(() => {
						fn(...args);
					}, delayTime);
				};
			};

			const MyGame = {
				data() {
					return {
						// 控制刚加载页面时，各子页面的显示/隐藏
						isShow: {
							pre: true,
							main: false,
							menu: false,
						},
						player: {
							name: "",
							isLeftWard: false,
							turnDur: 0.5,
							// [0]为当前玩家的初始值，后面是其他玩家的随机值
							hues: [180, Math.random() * 360, Math.random() * 360],
							grays: [0, Math.random() * 70, Math.random() * 100],
						},
						ball: {
							pos: [0, 0],
							moveDur: 0,
							owner: "player0",
							receptor: "player0",
						},
					};
				},
				methods: {
					checkInput(){
						let name = this.player.name;
						if(!name) {
							alert("请输入昵称！");
							return -1;
						} else if (name.length > 10) {
							alert("名字太长了！");
							return -1;
						}
					},
					togglePage(ballOwnerId) {
						this.isShow.pre = !this.isShow.pre;
						this.isShow.main = !this.isShow.main;
						if (this.isShow.main) {
							this.player.isLeftWard = false;
						}
						this.delayMoveBall(ballOwnerId);
					},
					enterGame() {
						// if(this.checkInput()) return 0;
						this.togglePage(0);
					},
					openMenu() {
						if (this.isShow.pre) {
							location = "index.html";
						}
						if (this.isShow.main) {
							// this.isShow.menu = true;
							this.togglePage("00");
						}
					},
					getTargetPos(dx) {
						let ballReceptor = this.$refs[this.ball.receptor];
						if (!ballReceptor) return this.ball.pos;
						let scalingSize = window.innerWidth / 100;
						let posX = (ballReceptor.offsetLeft + dx) / scalingSize;
						let posY = (ballReceptor.offsetTop - BALL_DY) / fontSize;
						return [posX, posY];
					},
					moveBall(receptorId = 0, ballMoveDur = 0.5, dx = BALL_DX) {
						// 设置移动参数
						this.ball.moveDur = ballMoveDur;
						this.ball.receptor = "player" + receptorId;
						// 移动
						if (this.ball.receptor == this.ball.owner) return -1;
						this.ball.pos = this.getTargetPos(dx);
						this.ball.owner = this.ball.receptor;
					},
					delayMoveBall(receptorId, ballMoveDur = 0) {
						let moveBall = delay(this.moveBall, LOAD_DELAY);
						moveBall(receptorId, ballMoveDur);
					},
					playerTurn(direction) {
						let turnLeft = direction == "left";
						if (turnLeft == this.player.isLeftWard) return -1;
						this.player.isLeftWard = turnLeft;

						if (this.ball.owner !== "player0") return -1;
						// 移动球
						const moveBall = (dx) => {
							this.ball.pos[0] += dx / (window.innerWidth / 100);
						};

						this.ball.moveDur = this.player.turnDur;
						if (turnLeft) moveBall(-BALL_DX);
						else moveBall(BALL_DX);
					},
				},

				mounted() {
					this.delayMoveBall("00");

					// Safari的filter+transition有问题，取消player_turn的动画
					if (navigator.userAgent.includes("AppleWebKit/6")) {
						this.player.turnDur = 0;
					}
				},
			};

			myGame = Vue.createApp(MyGame).mount("#game-page");
		</script>
	</body>
</html>
